(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[307],{62882:(e,t,r)=>{Promise.resolve().then(r.bind(r,46918))},76046:(e,t,r)=>{"use strict";var s=r(66658);r.o(s,"useParams")&&r.d(t,{useParams:function(){return s.useParams}}),r.o(s,"useRouter")&&r.d(t,{useRouter:function(){return s.useRouter}})},46918:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>h,dynamic:()=>p});var s=r(95155),a=r(12115),i=r(76046),n=r(2293),o=r(73312),l=r(22130),d=r(33900),c=r(98986),u=r(54208),m=r(30814);function f(e){let{visit:t}=e;return t?(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"mr-2",children:t.status_code||"draft_prep"}),t.scheduled_at&&(0,s.jsxs)("span",{className:"mr-2",children:["Sch: ",new Date(t.scheduled_at).toLocaleString()]}),t.started_at&&(0,s.jsxs)("span",{className:"mr-2",children:["Start: ",new Date(t.started_at).toLocaleString()]}),t.completed_at&&(0,s.jsxs)("span",{children:["Done: ",new Date(t.completed_at).toLocaleString()]})]}):null}let p="force-dynamic",v=(0,n.b)();function h(){let{svCode:e=""}=(0,i.useParams)()||{svCode:""},[t,r]=(0,a.useState)(null),[n,p]=(0,a.useState)("home");(0,a.useEffect)(()=>{(async()=>{let{data:t}=await v.from("site_visit").select("id, employer_id, job_site_id, status_code, started_at, completed_at, scheduled_at").eq("sv_code",e).maybeSingle();r(t)})()},[e]);let[h,x]=(0,a.useState)("3"),g=async()=>{if(!t)return;let{error:e}=await v.from("whs_assessment").upsert({site_visit_id:t.id,rating_code:h});if(e)return m.o.error(e.message);m.o.success("Saved"),p("home")},[_,b]=(0,a.useState)(null),[j,w]=(0,a.useState)("follow_up"),[y,N]=(0,a.useState)(""),S=async()=>{if(!t||!_)return;if("follow_up"===j&&!y)return m.o.error("Follow-up date/time required for follow-up outcome");let{error:e}=await v.from("dd_conversion_attempt").insert({site_visit_id:t.id,worker_id:_,method_code:"in_person",outcome_code:j,follow_up_at:"follow_up"===j&&y?new Date(y).toISOString():null,client_generated_id:crypto.randomUUID()});if(e)return m.o.error(e.message);m.o.success("Saved"),b(null),p("home")},k=async()=>{if(!t)return;let{error:e}=await v.from("site_visit").update({status_code:"in_progress",started_at:new Date().toISOString()}).eq("id",t.id);if(e)return m.o.error(e.message);r({...t,status_code:"in_progress",started_at:new Date().toISOString()}),m.o.success("Visit started")},C=async()=>{if(!t)return;let{error:e}=await v.from("site_visit").update({status_code:"completed",completed_at:new Date().toISOString(),outcomes_locked:!0}).eq("id",t.id);if(e)return m.o.error(e.message);r({...t,status_code:"completed",completed_at:new Date().toISOString(),outcomes_locked:!0}),m.o.success("Visit completed")};return t?(0,s.jsxs)("div",{className:"p-4 space-y-4",children:[(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:(0,s.jsx)(f,{visit:t})}),"home"===n&&(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,s.jsx)(o.$,{className:"h-24",onClick:()=>p("whs"),children:"WHS"}),(0,s.jsx)(o.$,{className:"h-24",onClick:()=>p("dd"),children:"Direct Debit"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,s.jsx)(o.$,{variant:"outline",onClick:k,disabled:(null==t?void 0:t.status_code)==="in_progress"||(null==t?void 0:t.status_code)==="completed",children:"Start"}),(0,s.jsx)(o.$,{variant:"outline",onClick:C,disabled:(null==t?void 0:t.status_code)!=="in_progress",children:"Complete"})]})]}),"whs"===n&&(0,s.jsxs)(l.Zp,{children:[(0,s.jsx)(l.aR,{children:(0,s.jsx)(l.ZB,{children:"WHS Quick"})}),(0,s.jsxs)(l.Wu,{className:"space-y-3",children:[(0,s.jsx)(c.J,{children:"Rating (1â€“5)"}),(0,s.jsx)("select",{className:"border rounded h-10 w-full px-2",value:h,onChange:e=>x(e.target.value),children:["1","2","3","4","5"].map(e=>(0,s.jsx)("option",{value:e,children:e},e))}),(0,s.jsx)(o.$,{onClick:g,children:"Save"}),(0,s.jsx)(o.$,{variant:"outline",onClick:()=>p("home"),children:"Back"})]})]}),"dd"===n&&(0,s.jsxs)(l.Zp,{children:[(0,s.jsx)(l.aR,{children:(0,s.jsx)(l.ZB,{children:"DD Quick"})}),(0,s.jsxs)(l.Wu,{className:"space-y-3",children:[(0,s.jsx)(u.M,{employerId:t.employer_id,value:_||"",onChange:e=>b(e)}),(0,s.jsx)(c.J,{children:"Outcome"}),(0,s.jsxs)("select",{className:"border rounded h-10 w-full px-2",value:j,onChange:e=>w(e.target.value),children:[(0,s.jsx)("option",{value:"converted",children:"Converted"}),(0,s.jsx)("option",{value:"already_on_dd",children:"Already on DD"}),(0,s.jsx)("option",{value:"follow_up",children:"Follow up"}),(0,s.jsx)("option",{value:"declined",children:"Declined"})]}),"follow_up"===j&&(0,s.jsxs)("div",{children:[(0,s.jsx)(c.J,{children:"Follow up at"}),(0,s.jsx)(d.p,{type:"datetime-local",value:y,onChange:e=>N(e.target.value)})]}),(0,s.jsx)(o.$,{onClick:S,disabled:!_,children:"Save"}),(0,s.jsx)(o.$,{variant:"outline",onClick:()=>p("home"),children:"Back"})]})]})]}):(0,s.jsx)("div",{className:"p-4",children:"Loading..."})}},73312:(e,t,r)=>{"use strict";r.d(t,{$:()=>d});var s=r(95155),a=r(12115),i=r(12317),n=r(31027),o=r(21567);let l=(0,n.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),d=a.forwardRef((e,t)=>{let{className:r,variant:a,size:n,asChild:d=!1,...c}=e,u=d?i.DX:"button";return(0,s.jsx)(u,{className:(0,o.cn)(l({variant:a,size:n,className:r})),ref:t,...c})});d.displayName="Button"},22130:(e,t,r)=>{"use strict";r.d(t,{Wu:()=>d,ZB:()=>l,Zp:()=>n,aR:()=>o});var s=r(95155),a=r(12115),i=r(21567);let n=a.forwardRef((e,t)=>{let{className:r,...a}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",r),...a})});n.displayName="Card";let o=a.forwardRef((e,t)=>{let{className:r,...a}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("flex flex-col space-y-1.5 p-6",r),...a})});o.displayName="CardHeader";let l=a.forwardRef((e,t)=>{let{className:r,...a}=e;return(0,s.jsx)("h3",{ref:t,className:(0,i.cn)("text-2xl font-semibold leading-none tracking-tight",r),...a})});l.displayName="CardTitle",a.forwardRef((e,t)=>{let{className:r,...a}=e;return(0,s.jsx)("p",{ref:t,className:(0,i.cn)("text-sm text-muted-foreground",r),...a})}).displayName="CardDescription";let d=a.forwardRef((e,t)=>{let{className:r,...a}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("p-6 pt-0",r),...a})});d.displayName="CardContent",a.forwardRef((e,t)=>{let{className:r,...a}=e;return(0,s.jsx)("div",{ref:t,className:(0,i.cn)("flex items-center p-6 pt-0",r),...a})}).displayName="CardFooter"},33900:(e,t,r)=>{"use strict";r.d(t,{p:()=>n});var s=r(95155),a=r(12115),i=r(21567);let n=a.forwardRef((e,t)=>{let{className:r,type:a,...n}=e;return(0,s.jsx)("input",{type:a,className:(0,i.cn)("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",r),ref:t,...n})});n.displayName="Input"},98986:(e,t,r)=>{"use strict";r.d(t,{J:()=>d});var s=r(95155),a=r(12115),i=r(46195),n=r(31027),o=r(21567);let l=(0,n.F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),d=a.forwardRef((e,t)=>{let{className:r,...a}=e;return(0,s.jsx)(i.b,{ref:t,className:(0,o.cn)(l(),r),...a})});d.displayName=i.b.displayName},54208:(e,t,r)=>{"use strict";r.d(t,{M:()=>l});var s=r(95155),a=r(12115),i=r(2293),n=r(98986);let o=(0,i.b)();function l(e){let{employerId:t,value:r,onChange:i}=e,[l,d]=(0,a.useState)([]),[c,u]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{let e=!1;return(async()=>{if(!t)return;u(!0);let{data:r,error:s}=await o.from("workers").select("id, first_name, surname, worker_placements!inner(employer_id)").eq("worker_placements.employer_id",t).limit(500);e||(s||d((r||[]).map(e=>({id:e.id,first_name:e.first_name,surname:e.surname}))),u(!1))})(),()=>{e=!0}},[t]),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(n.J,{children:"Worker"}),(0,s.jsxs)("select",{className:"border rounded h-10 w-full px-2",value:r||"",onChange:e=>i(e.target.value),disabled:c||!t,children:[(0,s.jsx)("option",{value:"",children:"Select worker"}),l.map(e=>(0,s.jsxs)("option",{value:e.id,children:[e.first_name," ",e.surname]},e.id))]})]})}},2293:(e,t,r)=>{"use strict";r.d(t,{b:()=>i});var s=r(51106),a=r(2818);function i(){let e=a.env.NEXT_PUBLIC_SUPABASE_URL||"https://jzuoawqxqmrsftbtjkzv.supabase.co",t=a.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6dW9hd3F4cW1yc2Z0YnRqa3p2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjYwMDcsImV4cCI6MjA2OTk0MjAwN30.iOvn3b02CX_Dch4bWlJbzY6EYLbWrmwpM7sQgAqimd8";return(0,s.UU)(e,t)}},21567:(e,t,r)=>{"use strict";r.d(t,{cn:()=>i});var s=r(43463),a=r(69795);function i(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,a.QP)((0,s.$)(t))}},46195:(e,t,r)=>{"use strict";r.d(t,{b:()=>o});var s=r(12115),a=r(23360),i=r(95155),n=s.forwardRef((e,t)=>(0,i.jsx)(a.sG.label,{...e,ref:t,onMouseDown:t=>{var r;t.target.closest("button, input, select, textarea")||(null===(r=e.onMouseDown)||void 0===r||r.call(e,t),!t.defaultPrevented&&t.detail>1&&t.preventDefault())}}));n.displayName="Label";var o=n}},e=>{var t=t=>e(e.s=t);e.O(0,[181,106,933,441,517,358],()=>t(62882)),_N_E=e.O()}]);